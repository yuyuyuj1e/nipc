{% extends 'other_base.html' %}
{% load static %}
{% block css %}
    <link rel="stylesheet" href="/static/plugins/bootstrap-datepicker/css/bootstrap-datepicker.min.css">
    <style>
        .icon-container {
            position: absolute;
            top: 10px;
            right: 10px;
            width: 30px;
            height: 30px;
            border: none;
            border-radius: 33%;
            /*border: 1px solid #ccc;
            box-shadow: 0 0 3px rgba(0, 0, 0, 0.3);*/
            text-align: center;
        }

        .icon-container i {
            position: relative;
            top: 20%;
            transform: translateY(-50%);
        }

        .badge {
            width: 50px;
            height: 30px;
            display: inline-block;
            padding: .25em .4em;
            font-size: 0.9rem;
            font-weight: 500;
            line-height: 22.5px;
            text-align: center;
            white-space: nowrap;
            vertical-align: baseline;
            border-radius: .25rem;
        }

        .position-absolute {
            right: 10px;
            bottom: 10px;
        }

        .move {
            transition: all 0.3s ease-in-out; /* 设置过渡效果 */
        }

        .move:hover {
            transform: scale(1.1); /* 放大1.1倍 */
            z-index: 1;
            {#box-shadow: 0px 0px 10px #ccc; /* 添加阴影效果 */#}
        }
    </style>

{% endblock %}


{% block name1 %}
    漏洞列表
{% endblock %}

{% block name2 %}
    漏洞列表
{% endblock %}

{% block other_content %}
    <div class="container">
        <div class="card">
            <div class="card-body pt-lg-5">
                <div class="input-group mb-5 justify-content-center">
                    <form method="post">
                        {% csrf_token %}
                        <div class="d-flex align-items-center">
                            <input id="search_text" type="text" class="form-control flex-grow-1 rounded-left"
                                   placeholder="搜索关键字： CVE编号"
                                   aria-label="Text input with dropdown button" name="query" value="{{ search_data }}"
                                   style="width: 600px; height: 60px !important;">
                            <div class="input-group-append" style="height: 60px">
                                <div class="input-group-text">
                                    <button class="btn" type="submit" id="search">搜索</button>
                                </div>
                            </div>
                        </div>
                    </form>
                </div>

            </div>


            <div class="container" style="padding-right: 0px">
                <div class="row w-100">
                    <!--分页 list-->
                    <div class="col-sm-8">
                        {% for id, no, level, name in queryset %}
                            <div class="card move" style="margin-bottom: 10px">
                                {% if level == 3 %}
                                    <div class="icon-container" style="background-color: #ffeded;">
                                        <i class="icon-bug" style="color: #ff4c4c"></i>
                                    </div>
                                {% elif level == 2 %}
                                    <div class="icon-container" style="background-color: #fff9e5;">
                                        <i class="icon-bug" style="color: #ffc100"></i>
                                    </div>

                                {% elif level == 1 %}
                                    <div class="icon-container" style="background-color: #F0FFF1;">
                                        <i class="icon-bug" style="color: #5bd60a"></i>
                                    </div>
                                {% else %}
                                    <div class="icon-container" style="background-color: #e5f3ff;">
                                        <i class="icon-bug" style="color: #409eff"></i>
                                    </div>
                                {% endif %}
                                <div class="card-body d-flex align-items-center justify-content-between flex-wrap shadow-sm">
                                    <h5 class="card-title mr-3 mb-0">{{ name }}</h5>
                                    <div class="w-100" style="padding: 5px"></div>
                                    <div class="row w-100">
                                        <p class="card-text col-4" style="font-weight: 500">{{ no }}</p>
                                        {% if level == 3 %}
                                            <div class="badge text-white col-1"
                                                 style="background-color: #ff4c4c">高危
                                            </div>
                                        {% elif level == 2 %}
                                            <div class="badge text-white col-1"
                                                 style="background-color: #ffc100">中危
                                            </div>
                                        {% elif level == 1 %}
                                            <div class="badge text-white col-1"
                                                 style="background-color: #5bd60a">低危
                                            </div>
                                        {% else %}
                                            <div class="badge text-white col-1"
                                                 style="background-color: #409eff">未知
                                            </div>
                                        {% endif %}
                                    </div>
                                    <div class="w-100"></div>
                                    <div class="mt-2 ms-auto me-3 position-absolute bottom-0 end-0">
                                        <a href="/vulnerability/{{ id }}/" class="btn btn-primary">详情</a>
                                    </div>
                                </div>
                            </div>
                        {% endfor %}
                    </div>
                    <!--end list-->
                    <!--高级搜索-->
                    <div class="card col-sm-4" style="height: 350px; width: 362px">
                        <div class="card-header row text-center">
                            高级搜索
                        </div>
                        <div class="card-body">
                            <form method="post" id="advancedForm" autocomplete="off">
                                {% csrf_token %}
                                <!--危险等级-->
                                <div class="row mt-4">
                                    <div class="input-group" style="width: 315px">
                                        <label for="levelInput"
                                               style="font-size: medium; margin-right: 20px; margin-top: 5px">危险等级</label>
                                        <input style="width: 100px; height: 30px !important;" type="text"
                                               class="form-control dropdown-toggle rounded  level" placeholder="请选择..."
                                               data-toggle="dropdown" aria-haspopup="true" aria-expanded="false"
                                               id="levelInput" >
                                        <div class="input-group-append" style="height: 30px !important; width: 15px">
                                            <button class="btn btn-outline-secondary dropdown-toggle" type="button"
                                                    data-toggle="dropdown" aria-haspopup="true"
                                                    aria-expanded="false" id="myDropdownBtn"></button>
                                            <div class="dropdown-menu level-menu" aria-labelledby="levelInput"
                                                 id="myDropdownMenu">
                                                <a class="dropdown-item" data-value="0">未知</a>
                                                <a class="dropdown-item" data-value="1">低危</a>
                                                <a class="dropdown-item" data-value="2">中危</a>
                                                <a class="dropdown-item" data-value="3">高危</a>
                                            </div>
                                        </div>
                                    </div>
                                </div>
                                <!--时间类型-->
                                <div class="row mt-4">
                                    <div class="input-group" style="width: 315px">
                                        <label for="timeInput"
                                               style="font-size: medium; margin-right: 20px; margin-top: 5px">时间类型</label>
                                        <input style="width: 100px; height: 30px !important;" type="text"
                                               class="form-control dropdown-toggle rounded time" placeholder="请选择..."
                                               data-toggle="dropdown" aria-haspopup="true" aria-expanded="false"
                                               id="timeInput">
                                        <div class="input-group-append" style="height: 30px !important; width: 15px">
                                            <button class="btn btn-outline-secondary dropdown-toggle" type="button"
                                                    data-toggle="dropdown" aria-haspopup="true"
                                                    aria-expanded="false" id="myDropdownBtn"></button>
                                            <div class="dropdown-menu time-menu" aria-labelledby="timeInput"
                                                 id="myDropdownMenu">
                                                <a class="dropdown-item" data-value="publishtime">发布时间</a>
                                                <a class="dropdown-item" data-value="updatetime">更新时间</a>
                                            </div>
                                        </div>
                                    </div>
                                </div>
                                <!--时间选项-->
                                <div class="row mt-4">
                                    <div class="input-group">

                                        <label for=""
                                               style="font-size: medium; margin-right: 20px; margin-top: 5px">时间选项</label>
                                        <div class="form-group border rounded d-flex">
                                            <input style="width: 110px; height: 30px !important;" type="text" name="startDate"
                                                   class="form-control border-0" placeholder="起始日期" id="startDate">
                                            <span class="d-flex align-items-center px-2">-</span>
                                            <input style="width: 110px; height: 30px !important;" type="text" name="endDate"
                                                   class="form-control border-0" placeholder="终止日期" id="endDate">
                                        </div>


                                    </div>
                                </div>

                                <div class="row mt-4">
                                    <div class="col d-flex justify-content-center">
                                        <button class="btn btn-primary" type="submit" id="confirmBtn">确认</button>
                                        <div style="width:20px;"></div>
                                        <button class="btn btn-outline-secondary" type="button" id="clearBtn">取消
                                        </button>
                                    </div>
                                </div>
                            </form>

                        </div>
                    </div>
                    <!--end高级搜索-->
                </div>
            </div>
            <div class="h-100"></div>
            <!--分页-->
            <nav aria-label="Page navigation" style="margin-top: 20px;margin-bottom: 50px;">
                <ul class="pagination justify-content-center">
                    {{ page_string }}
                </ul>
            </nav>
            <!--end分页-->
            <div class="h-100"></div>

        </div>
    </div>


{% endblock %}

{% block js %}
    <script src="/static/plugins/bootstrap-datepicker/js/bootstrap-datepicker.min.js"></script>
    <script src="/static/plugins/bootstrap-datepicker/locales/bootstrap-datepicker.zh-CN.min.js"></script>
    <script>
        // 定义全局变量存data-value
        var LEVEL;
        var DATETYPE;
        // 将下拉框中的值显示在input框中
        $('.input-group-append .level-menu a').click(function () {
            var text = $(this).text();
            LEVEL = $(this).data('value')
            $('#advancedForm').append('<input type="hidden" name="level" value="' + LEVEL + '">')
            $('#levelInput').val(text);
        });
        $('.input-group-append .time-menu a').click(function () {
            var text = $(this).text();
            DATETYPE = $(this).data('value')
            $('#advancedForm').append('<input type="hidden" name="date_type" value="' + DATETYPE + '">')
            $('#timeInput').val(text);
        });

        // 点击input框时展示下拉框
        $(function () {
            // 危险等级
            $('.dropdown-toggle .level').on('click', function () {
                $(this).parent().find('.dropdown-menu .level-menu').toggle();
            });
            // 时间类型
            $('.dropdown-toggle .time').on('click', function () {
                $(this).parent().find('.dropdown-menu .time-menu').toggle();
            });
        });


        // 将日期显示成用户选择，而不是输入的形式
        $(function () {
            $('#startDate').datepicker({
                format: 'yyyy-mm-dd',
                startDate: '1900-01-01',
                endDate: '0',
                language: "zh-CN",
                autoclose: true,
            });
            $('#endDate').datepicker({
                format: 'yyyy-mm-dd',
                startDate: '1900-01-01',
                endDate: '0',
                language: "zh-CN",
                autoclose: true,
            });
        })

        // 点击取消置空高级搜索框,同时置空两个全局变量
        $("#clearBtn").click(function () {
            $("#advancedForm")[0].reset();
            DATETYPE = ''
            LEVEL = ''
        });


        // 点击确定
        /*$("#confirmBtn").click(function () {
            var startDate = document.getElementById("startDate").value;
            var endDate = document.getElementById("endDate").value;
            $.ajax({
                url: '/vulnerability/',
                type: 'get',
                data: {level: LEVEL, date_type: DATETYPE, startDate: startDate, endDate: endDate},
                success: function (response) {
                    console.log(response);
                },
                error: function (error) {
                    console.log(error);
                }
            });
        })*/

    </script>
{% endblock %}